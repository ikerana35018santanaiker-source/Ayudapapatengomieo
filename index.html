<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geometry Dash 3D Clone</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden; background:#222; font-family:sans-serif; }
  canvas { display:block; }

  /* Pantallas */
  #startScreen, #menu, #levelSelect, #gameOver { 
    position:absolute; top:0; left:0; width:100%; height:100%; 
    display:flex; justify-content:center; align-items:center; flex-direction:column; 
    color:white; z-index:10; 
  }
  #startScreen { background:#222; }
  #menu { display:none; background:rgba(0,0,0,0.7); }
  #levelSelect, #gameOver { display:none; background:rgba(0,0,0,0.7); }

  /* Botones */
  button { padding:15px 30px; margin:10px; font-size:1em; border:none; border-radius:10px; background:#ffcc00; color:#222; cursor:pointer; transition: transform 0.2s; }
  button:hover { transform: scale(1.1); }
</style>
</head>
<body>

<!-- Pantalla de inicio -->
<div id="startScreen">
  <button id="startBtn" style="font-size:2em;padding:20px 40px;">Empezar</button>
</div>

  <!-- Progress bar -->
<div id="progressContainer" style="position:absolute;top:10px;left:10px;width:80%;height:20px;background:#555;border-radius:10px;">
  <div id="progressBar" style="width:0%;height:100%;background:#ffcc00;border-radius:10px;"></div>
</div>

<!-- Menú principal -->
<div id="menu">
  <h1>Geometry Dash 3D</h1>
  <button id="playBtn">Play</button>
  <button id="settingsBtn">Settings</button>
  <button id="exitBtn">Exit</button>
  <canvas id="menuCanvas" style="position:absolute;top:0;left:0;z-index:-1;"></canvas>
</div>

<!-- Selector de niveles -->
<div id="levelSelect">
  <h2>Select Level</h2>
  <button class="levelBtn" data-level="1">Level 1</button>
  <button class="levelBtn" data-level="2">Level 2</button>
  <button class="levelBtn" data-level="3">Level 3</button>
  <button id="backMenuBtn">Back</button>
</div>

<!-- Game Over -->
<div id="gameOver">
  <h2>Game Over</h2>
  <button id="retryBtn">Retry</button>
  <button id="menuBtn">Menu</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.179.0/build/three.module.js';

// ===== Variables globales =====
let scene, camera, renderer;
let player, obstacles = [];
let speed = 0.15, jump = 0.3, gravity = -0.01, velocityY = 0;
let isJumping = false, gameStarted = false;
let level = 1;

// Música
let menuAudio = new Audio('Background.mp3'); menuAudio.loop=true;
let levelAudio = null;

// UI
const startScreen = document.getElementById('startScreen');
const startBtn = document.getElementById('startBtn');
const menuDiv = document.getElementById('menu');
const levelSelectDiv = document.getElementById('levelSelect');
const gameOverDiv = document.getElementById('gameOver');
const playBtn = document.getElementById('playBtn');
const backMenuBtn = document.getElementById('backMenuBtn');
const retryBtn = document.getElementById('retryBtn');
const menuBtn = document.getElementById('menuBtn');
const levelBtns = document.querySelectorAll('.levelBtn');

// ===== Menú animado =====
let menuScene, menuCamera, menuRenderer, menuCube, menuObstacles=[];
function initMenuAnimation(){
  const canvas = document.getElementById('menuCanvas');
  menuScene = new THREE.Scene();
  menuCamera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight,0.1,1000);
  menuRenderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
  menuRenderer.setSize(window.innerWidth, window.innerHeight);

  // Luz
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(5,10,5);
  menuScene.add(light);

  // Cubo saltando
  const cubeGeo = new THREE.BoxGeometry(1,1,1);
  const cubeMat = new THREE.MeshPhongMaterial({color:0xff0000});
  menuCube = new THREE.Mesh(cubeGeo, cubeMat);
  menuCube.position.set(-5,0.5,0);
  menuScene.add(menuCube);

  // Obstáculos
  for(let i=0;i<10;i++){
    const obsGeo = new THREE.BoxGeometry(1,1,1);
    const obsMat = new THREE.MeshPhongMaterial({color:0x00ff00});
    const obs = new THREE.Mesh(obsGeo,obsMat);
    obs.position.set(i*5+5,0.5,0);
    menuScene.add(obs);
    menuObstacles.push(obs);
  }

  menuCamera.position.set(-10,5,10);
  menuCamera.lookAt(menuCube.position);

  animateMenu();
}

let menuVelocityY = 0;
function animateMenu(){
  requestAnimationFrame(animateMenu);
  // Cubo saltando animado
  menuVelocityY += -0.01; // gravedad
  menuCube.position.y += menuVelocityY;
  if(menuCube.position.y <=0.5){ menuCube.position.y=0.5; menuVelocityY=0.2; }
  // Obstáculos se mueven al fondo
  menuObstacles.forEach(obs=>{
    obs.position.x -= speed/2;
    if(obs.position.x < -10) obs.position.x += 50;
  });
  menuRenderer.render(menuScene, menuCamera);
}

// ===== Eventos UI =====
startBtn.addEventListener('click', ()=>{
  startScreen.style.display='none';
  menuDiv.style.display='flex';
  menuAudio.play();
  initMenuAnimation();
});

playBtn.addEventListener('click', ()=>{
  menuDiv.style.display='none';
  levelSelectDiv.style.display='flex';
});

backMenuBtn.addEventListener('click', ()=>{
  levelSelectDiv.style.display='none';
  menuDiv.style.display='flex';
});

levelBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    level = parseInt(btn.dataset.level);
    // Pausar música del menú
    menuAudio.pause(); menuAudio.currentTime=0;
    // Música del nivel
    if(levelAudio){ levelAudio.pause(); levelAudio.currentTime=0; }
    levelAudio = new Audio(`Level${level}.mp3`);
    levelAudio.loop=true;
    levelAudio.play();
    levelSelectDiv.style.display='none';
    startGame();
  });
});

retryBtn.addEventListener('click', ()=>{
  if(levelAudio){ levelAudio.pause(); levelAudio.currentTime=0; levelAudio.play(); }
  gameOverDiv.style.display='none';
  startGame();
});

menuBtn.addEventListener('click', ()=>{
  if(levelAudio){ levelAudio.pause(); levelAudio.currentTime=0; }
  menuAudio.play();
  gameOverDiv.style.display='none';
  menuDiv.style.display='flex';
});

// ===== Juego principal =====
function initGame(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight,0.1,1000);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(5,10,5);
  scene.add(light);

  const floorGeo = new THREE.BoxGeometry(1000,1,10);
  const floorMat = new THREE.MeshPhongMaterial({color:0x444444});
  const floor = new THREE.Mesh(floorGeo,floorMat);
  floor.position.set(0,-1,0);
  scene.add(floor);

  const cubeGeo = new THREE.BoxGeometry(1,1,1);
  const cubeMat = new THREE.MeshPhongMaterial({color:0xff0000});
  player = new THREE.Mesh(cubeGeo,cubeMat);
  player.position.set(-5,0.5,0);
  scene.add(player);

  generateObstacles();

  camera.position.set(-10,5,10);
  camera.lookAt(player.position);

  window.addEventListener('mousedown', jumpPlayer);
  window.addEventListener('touchstart', jumpPlayer);

  animateGame();
}

function generateObstacles(){
  obstacles.forEach(obs=>scene.remove(obs));
  obstacles=[];
  let posX = 25;

  for(let i=0;i<30;i++){
    const type = Math.random() < 0.3 ? 'spike' : 'cube'; // 30% pinchos
    let obs;

    if(type==='cube'){
      const geo = new THREE.BoxGeometry(1,1,1);
      const mat = new THREE.MeshPhongMaterial({color:0xff0000});
      obs = new THREE.Mesh(geo, mat);
      obs.position.y = 0.5;
    } else {
      const geo = new THREE.ConeGeometry(0.5,1,4); // pincho
      const mat = new THREE.MeshPhongMaterial({color:0x0000ff});
      obs = new THREE.Mesh(geo, mat);
      obs.position.y = 0.5; 
      obs.rotation.z = Math.PI; // pincho hacia arriba
    }

    // Variación de altura (0.5 a 2)
    obs.position.y += Math.random()*1.5;
    // Distancia aleatoria entre 3 y 7
    posX += 3 + Math.random()*4;
    obs.position.x = posX;
    obs.position.z = 0;

    scene.add(obs);
    obstacles.push(obs);
  }
}

function jumpPlayer(){ if(!isJumping){ velocityY=jump; isJumping=true; } }

const progressBar = document.getElementById('progressBar');
const levelLength = 100; // distancia total del nivel

function animateGame(){
  requestAnimationFrame(animateGame);
  if(gameStarted){
    player.position.x += speed;
    velocityY += gravity;
    player.position.y += velocityY;
    if(player.position.y<=0.5){ player.position.y=0.5; velocityY=0; isJumping=false; }

    obstacles.forEach(obs=>{
      if(player.position.x+0.5>obs.position.x-0.5 && player.position.x-0.5<obs.position.x+0.5){
        if(player.position.y-0.5<obs.position.y+0.5){ gameOver(); }
      }
    });

    // Actualiza progress bar
    let progress = (player.position.x + 5) / levelLength; // +5 por offset inicial
    if(progress>1) progress=1;
    progressBar.style.width = (progress*100)+'%';

    camera.position.x = player.position.x - 10;
    camera.lookAt(player.position);
  }
  renderer.render(scene,camera);
}

function gameOver(){
  gameStarted=false;
  gameOverDiv.style.display='flex';
  levelAudio.pause()
}

function startGame(){
  gameOverDiv.style.display='none';
  if(!scene) initGame();
  player.position.set(-5,0.5,0);
  velocityY=0; isJumping=false; gameStarted=true;
  generateObstacles();
}
</script>
</body>
</html>
